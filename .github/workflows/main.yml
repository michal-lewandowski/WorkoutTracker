name: WorkoutTracker CI/CD

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:  # Enable manual trigger

jobs:
  build-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      php_image: ${{ steps.image-tags.outputs.php_image }}
      frontend_image: ${{ steps.image-tags.outputs.frontend_image }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set repository name to lowercase
      id: repo-name
      run: |
        REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        echo "repo_name_lower=$REPO_NAME" >> $GITHUB_OUTPUT
        echo "Repository name lowercase: $REPO_NAME"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract Docker metadata for PHP
      id: meta-php
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ steps.repo-name.outputs.repo_name_lower }}-php
        tags: |
          type=sha,format=short
          type=ref,event=branch
          latest

    - name: Extract Docker metadata for Frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ steps.repo-name.outputs.repo_name_lower }}-frontend
        tags: |
          type=sha,format=short
          type=ref,event=branch
          latest

    - name: Build and push PHP image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: frankenphp_dev
        push: true
        tags: ${{ steps.meta-php.outputs.tags }}
        labels: ${{ steps.meta-php.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        target: deps
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Output image tags for other jobs
      id: image-tags
      run: |
        echo "php_image=$(echo '${{ steps.meta-php.outputs.tags }}' | head -n 1)" >> $GITHUB_OUTPUT
        echo "frontend_image=$(echo '${{ steps.meta-frontend.outputs.tags }}' | head -n 1)" >> $GITHUB_OUTPUT
        
        # Print image tags for debugging
        echo "PHP image: $(echo '${{ steps.meta-php.outputs.tags }}' | head -n 1)"
        echo "Frontend image: $(echo '${{ steps.meta-frontend.outputs.tags }}' | head -n 1)"

  backend-tests:
    runs-on: ubuntu-latest
    needs: [build-images]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: workout_tracker_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get PHP image tag from previous job
      run: |
        PHP_IMAGE="${{ needs.build-images.outputs.php_image }}"
        echo "Using PHP image: $PHP_IMAGE"
        echo "PHP_IMAGE=$PHP_IMAGE" >> $GITHUB_ENV
    
    - name: Run tests in Docker container
      run: |
        # Run PHPUnit tests in container
        docker run --network host \
          -e DATABASE_URL="postgresql://postgres:postgres@localhost:5432/workout_tracker_test?serverVersion=15&charset=utf8" \
          -e APP_ENV=test \
          -v ${{ github.workspace }}:/app \
          ${{ env.PHP_IMAGE }} \
          php bin/phpunit
          
    - name: Run PHPStan in Docker container
      run: |
        docker run \
          -v ${{ github.workspace }}:/app \
          ${{ env.PHP_IMAGE }} \
          vendor/bin/phpstan analyse src --level=5

  frontend-tests:
    runs-on: ubuntu-latest
    needs: [build-images]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Get Frontend image tag from previous job
      run: |
        FRONTEND_IMAGE="${{ needs.build-images.outputs.frontend_image }}"
        echo "Using Frontend image: $FRONTEND_IMAGE"
        echo "FRONTEND_IMAGE=$FRONTEND_IMAGE" >> $GITHUB_ENV
    
    - name: Run frontend linting in Docker container
      run: |
        docker run \
          -v ${{ github.workspace }}/frontend:/app \
          ${{ env.FRONTEND_IMAGE }} \
          npm run lint
    
    - name: Run frontend build in Docker container
      run: |
        docker run \
          -v ${{ github.workspace }}/frontend:/app \
          ${{ env.FRONTEND_IMAGE }} \
          npm run build

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, build-images]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set repository name to lowercase
      id: repo-name
      run: |
        REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        echo "repo_name_lower=$REPO_NAME" >> $GITHUB_OUTPUT
        
    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Start services with Docker Compose
      run: |
        # Pull the images we built earlier
        docker pull ${{ needs.build-images.outputs.php_image }}
        docker pull ${{ needs.build-images.outputs.frontend_image }}
        
        # Create a docker-compose override file to use our specific images
        cat > docker-compose.override.yml << EOL
        version: '3'
        services:
          php:
            image: ${{ needs.build-images.outputs.php_image }}
          frontend:
            image: ${{ needs.build-images.outputs.frontend_image }}
        EOL
        
        # Start all services
        docker compose -f compose.yaml up -d
    
    - name: List running containers
      run: docker ps -a
      
    - name: Install Playwright
      run: |
        npm ci
        npx playwright install --with-deps

    - name: Wait for services to be ready
      run: |
        sleep 20
        # Check that services are running
        curl --retry 8 --retry-delay 5 http://localhost:80 || echo "Frontend not responding"
        curl --retry 8 --retry-delay 5 http://localhost:80/api || echo "Backend not responding"
    
    - name: Run E2E Tests
      run: |
        npx playwright test
        
    - name: Collect test artifacts on failure
      if: failure()
      run: |
        mkdir -p playwright-report-artifact
        cp -r playwright-report/* playwright-report-artifact/ || echo "No test artifacts to collect"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-results
        path: playwright-report-artifact/
        retention-days: 7
        
    - name: Shutdown services
      if: always()
      run: docker compose down --volumes

  build-production:
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    permissions:
      contents: read
      packages: write
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set repository name to lowercase
      id: repo-name
      run: |
        REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        echo "repo_name_lower=$REPO_NAME" >> $GITHUB_OUTPUT

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract Docker metadata for PHP Production
      id: meta-php-prod
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ steps.repo-name.outputs.repo_name_lower }}-php-prod
        tags: |
          type=sha,format=short
          type=ref,event=branch
          latest

    - name: Extract Docker metadata for Frontend Production
      id: meta-frontend-prod
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ steps.repo-name.outputs.repo_name_lower }}-frontend-prod
        tags: |
          type=sha,format=short
          type=ref,event=branch
          latest

    - name: Build and push PHP production image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: frankenphp_prod
        push: true
        tags: ${{ steps.meta-php-prod.outputs.tags }}
        labels: ${{ steps.meta-php-prod.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push frontend production image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        target: runner
        push: true
        tags: ${{ steps.meta-frontend-prod.outputs.tags }}
        labels: ${{ steps.meta-frontend-prod.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Create docker-compose.override.yml for production verification
      run: |
        cat > docker-compose.override.yml << EOL
        version: '3'
        services:
          php:
            image: ${{ steps.meta-php-prod.outputs.tags }}
          frontend:
            image: ${{ steps.meta-frontend-prod.outputs.tags }}
        EOL
        
    - name: Start production services
      run: |
        docker compose -f compose.yaml -f compose.prod.yaml up -d
        
    - name: Verify services started
      run: docker ps
        
    - name: Check backend health
      run: |
        # Wait for backend to be available
        curl --fail --retry 8 --retry-delay 5 http://localhost/api/health || exit 1
        
    - name: Check frontend health
      run: |
        # Wait for frontend to be available
        curl --fail --retry 8 --retry-delay 5 http://localhost/ || exit 1
        
    - name: Cleanup
      if: always()
      run: docker compose -f compose.yaml -f compose.prod.yaml down --volumes